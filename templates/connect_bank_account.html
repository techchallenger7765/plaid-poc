<div class="container mt-4 text-center">
    <h1 class="display-4">Welcome!</h1>
    <hr class="my-4">
    <p>To start, please verify and connect your bank account.</p>
    <p class="lead">
        <a class="btn btn-primary btn-lg" id="link-button" role="button">Connect</a>
        <button class="btn btn-primary btn-lg" id="loading-button" type="button" disabled hidden>
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            Loading...
        </button>
    </p>
</div>

<script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
<script>
    var linkButton = document.getElementById('link-button');
    var loadingButton = document.getElementById('loading-button');
    linkButton.onclick = async function () {
        linkButton.hidden = true;
        loadingButton.hidden = false;
        const response = await fetch('/fetchLinkToken/', {});
        // Initialize the Plaid Link component
        await response.json().then(jsonResponse => {
            const linkToken = jsonResponse["link_token"];
            var linkHandler = Plaid.create({
                token: linkToken, // The Link token generated by your server-side code
                onSuccess: function (public_token, metadata) {
                    // Send the public_token to your server-side code to exchange for an access_token
                    var xhr = new XMLHttpRequest();
                    xhr.open('POST', '/verifyBankAccount/');
                    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                    xhr.onload = function () {
                        if (xhr.status === 200) {
                            alert('Bank account verified and saved successfully');
                            window.location.reload();
                        } else {
                            alert('Failed to verify bank account');
                            window.location.reload();
                        }
                    };
                    xhr.send('public_token=' + encodeURIComponent(public_token) + '&account_id=' + encodeURIComponent(metadata.accounts[0].id));
                },
                onExit: function (error, metadata) {
                    if (error != null) {
                        alert('Failed to connect bank account');
                        window.location.reload();
                    }
                    linkButton.hidden = false;
                    loadingButton.hidden = true;
                }
            });
            // Open the Plaid Link component
            linkHandler.open();
        })
    };
</script>